<!doctype html>
<html lang="en">
<head>
	<title>Chase Camera (Three.js)</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link rel=stylesheet href="css/base.css"/>
</head>
<body>

	<script src="three.js-master/build/three.js"></script>
	<script src="stats.js"></script>
	<script src="three.js-master/examples/js/controls/OrbitControls.js"></script>

<div id="ThreeJS" style="position: absolute; left:0px; top:0px"></div>
<script>

// standard global variables
var container, scene, camera, renderer, controls, stats;
var clock = new THREE.Clock();
// custom global variables
var horse;
var mixer;

init();
animate();

// FUNCTIONS
function init()
{
	// SCENE
	scene = new THREE.Scene();
	scene.background = new THREE.Color( 0xf0f0f0 );

	// CAMERA
	var SCREEN_WIDTH = window.innerWidth, SCREEN_HEIGHT = window.innerHeight;

	var VIEW_ANGLE = 45, ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = 0.1, FAR = 20000;

	camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);
	scene.add(camera);
	camera.position.set(0,150,400);
	camera.lookAt(scene.position);


	// RENDERER
	renderer = new THREE.WebGLRenderer( {antialias:true} );
	renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
	container = document.getElementById( 'ThreeJS' );
	container.appendChild( renderer.domElement );

	//LIGHT
	var light = new THREE.DirectionalLight( 0xefefff, 1.5 );
	light.position.set( 1, 1, 1 ).normalize();
	scene.add( light );
	var light = new THREE.DirectionalLight( 0xffefef, 1.5 );
	light.position.set( -1, -1, -1 ).normalize();
	scene.add( light );

	// STATS
	stats = new Stats();
	stats = new Stats();
	container.appendChild( stats.dom );

	// LIGHT
	var light = new THREE.PointLight(0xffffff);
	light.position.set(0, 250, 0);
	scene.add(light);

	// FLOOR
	var floorTexture = new THREE.ImageUtils.loadTexture( 'checkerboard.jpg' );
	floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping;
	floorTexture.repeat.set( 10, 10 );
	var floorMaterial = new THREE.MeshBasicMaterial( { map: floorTexture, side: THREE.DoubleSide } );
	var floorGeometry = new THREE.PlaneGeometry(1000, 1000, 10, 10);
	var floor = new THREE.Mesh(floorGeometry, floorMaterial);
	floor.position.y = -0.5;
	floor.rotation.x = Math.PI / 2;
	scene.add(floor);

	// HORSE
	var loader = new THREE.JSONLoader();

	loader.load("horse.js", function( geometry ) {
		horse = new THREE.Mesh( geometry, new THREE.MeshLambertMaterial( {
			vertexColors: THREE.FaceColors,
			morphTargets: true
		}));

		horse.scale.set(1, 1, 1);

		horse.rotation.y = Math.PI;

		scene.add(horse);

		//animation
		mixer = new THREE.AnimationMixer( horse );
		var clip = THREE.AnimationClip.CreateFromMorphTargetSequence( 'gallop', geometry.morphTargets, 30 );
		mixer.clipAction( clip ).setDuration( 1 ).play();
	});
}


var moving = false;

var key = '';

function onDocumentKeyDown(event) {
	var keyCode = event.which;
	switch (keyCode) {

		case 87:
			key = 'W';
			moving = true;
			break;

		case 83:
			key = 'S';
			moving = true;
			break;

		case 81:
			key = 'Q';
			moving = true;
			break;

		case 69:
			key = 'E';
			moving = true;
			break;

		case 65:
			key = 'A';
			moving = true;
			break;

		case 68:
			key = 'D';
			moving = true;
			break;

		case 82:
			key = 'R';
			moving = true;
			break;

		case 70:
			key = 'F';
			moving = true;
			break;

		case 90:
			key = 'Z';
			moving = true;
			break;
	}

	render();
}

document.addEventListener("keydown", onDocumentKeyDown, false);

function onDocumentKeyUp(event) {
	moving = false;
	render();
}

document.addEventListener("keyup", onDocumentKeyUp, false);

function animate()
{
	requestAnimationFrame(animate);
	render();
	update();
}



function update()
{
	var delta = clock.getDelta(); // seconds.
	var moveDistance = 200 * delta; // 200 pixels per second
	var rotateAngle = Math.PI / 2 * delta;   // pi/2 radians (90 degrees) per second

	if (horse) { //ver se existe objecto cavalo
		if (moving) {
			if ( key == 'W'){
				horse.translateZ( -moveDistance );
			}
			if ( key == 'S'){
				horse.translateZ( moveDistance );
			}

			if ( key == 'Q'){
				horse.translateX( -moveDistance );
			}

			if ( key == 'E'){
				horse.translateX( moveDistance );
			}
			if ( key == 'A'){
				horse.rotateOnAxis(new THREE.Vector3(0,1,0), rotateAngle);
			}

			if ( key == 'D'){
				horse.rotateOnAxis(new THREE.Vector3(0,1,0), -rotateAngle);
			}

			if ( key == 'R'){
				horse.rotateOnAxis(new THREE.Vector3(1,0,0), rotateAngle);
			}

			if ( key == 'F'){
				horse.rotateOnAxis(new THREE.Vector3(1,0,0), -rotateAngle);
			}


			var relativeCameraOffset = new THREE.Vector3(0, 200, 600);

			var cameraOffset = relativeCameraOffset.applyMatrix4(horse.matrixWorld);

			camera.position.x = cameraOffset.x;
			camera.position.y = cameraOffset.y;
			camera.position.z = cameraOffset.z;
			camera.lookAt(horse.position);
			stats.update();
		}
	}
}

var radius = 600;
var theta = 0;
var prevTime = Date.now();

function render()
{
	theta += 0.1;
	//camera.position.x = radius * Math.sin( THREE.Math.degToRad( theta ) );
	//camera.position.z = radius * Math.cos( THREE.Math.degToRad( theta ) );

	if ( mixer ) {
		var time = Date.now();
		mixer.update( ( time - prevTime ) * 0.001 );
		prevTime = time;
	}
	renderer.render( scene, camera );
}

</script>

</body>
</html>
